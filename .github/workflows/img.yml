name: 图片爬虫

on:
  schedule:
    - cron: '18 4 * * *'  # 每天北京时间 12:18 运行
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install \
            playwright \
            cloudscraper \
            beautifulsoup4 \
            lxml \
            opencv-python-headless \
            requests
          playwright install chromium
      
      - name: 提交并推送
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
        run: python scripts/scraper.py
        
      - name: 清理工作流记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
